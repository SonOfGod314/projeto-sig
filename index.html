<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IceTrack - Plataforma de Análise de Geleiras</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .legend { padding: 6px 10px; font: 14px/16px Arial, Helvetica, sans-serif; background: rgba(255, 255, 255, 0.9); box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); border-radius: 8px; line-height: 18px; color: #333; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.8; border: 1px solid #999;}
        #info-panel { transition: transform 0.3s ease-in-out; }
        .loader { border: 4px solid #4A5568; border-top: 4px solid #63B3ED; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sidebar::-webkit-scrollbar { width: 8px; }
        #sidebar::-webkit-scrollbar-track { background: #1A202C; }
        #sidebar::-webkit-scrollbar-thumb { background: #4A5568; border-radius: 4px; }
        #sidebar::-webkit-scrollbar-thumb:hover { background: #718096; }
        .leaflet-popup-content-wrapper, .leaflet-tooltip { background-color: #2D3748; color: #E2E8F0; border-color: #4A5568; }
        .leaflet-popup-tip { background-color: #2D3748; }
        .leaflet-tooltip-top:before { border-top-color: #4A5568; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-800 text-white">
    <div class="absolute top-2 left-2 z-[1000] bg-white px-3 py-1 rounded-md shadow-lg">
    <a href="home.html" class="text-sm text-blue-600 hover:underline">&larr; Home</a>
</div>

    <div class="flex h-screen">
        <!-- PAINEL ESQUERDO: Controles e Dashboard -->
        <aside id="sidebar" class="w-96 bg-gray-900 text-white p-6 flex flex-col space-y-6 overflow-y-auto">
            <!-- Título -->
            <div>
                <h1 class="text-3xl font-bold text-center text-cyan-400">IceTrack</h1>
                <p class="text-sm text-center text-gray-400">Plataforma de Análise do Recuo de Geleiras</p>
            </div>

            <!-- Dashboard de Estatísticas Globais -->
            <div id="stats-dashboard" class="space-y-3"></div>

            <!-- Filtros e Busca -->
            <div class="flex-grow">
                <h3 class="font-bold text-lg mb-3 text-cyan-400 border-b border-gray-700 pb-2">Explorar Geleiras</h3>
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="continente-select" class="block text-sm font-medium text-gray-400">Continente</label>
                        <select id="continente-select" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option>Todos</option><option>Antarctica</option><option>Asia</option><option>Europe</option><option>North America</option><option>Oceania</option><option>South America</option>
                        </select>
                    </div>
                     <div>
                        <label for="pais-select" class="block text-sm font-medium text-gray-400">País</label>
                        <select id="pais-select" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option disabled selected>A carregar...</option>
                        </select>
                    </div>
                    <div>
                        <label for="ano-inicial" class="block text-sm font-medium text-gray-400">Período de</label>
                        <input type="number" id="ano-inicial" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" value="1980">
                    </div>
                    <div>
                        <label for="ano-final" class="block text-sm font-medium text-gray-400">Até</label>
                        <input type="number" id="ano-final" class="w-full mt-1 p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" value="2020">
                    </div>
                    <div class="flex items-center space-x-2 pt-2">
                        <button id="filter-button" class="flex-grow bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                            <span>Analisar</span>
                        </button>
                        <div id="loading-indicator" class="loader hidden"></div>
                    </div>
                </div>
                <h3 class="font-bold text-lg mt-6 mb-3 text-cyan-400 border-b border-gray-700 pb-2">Buscar por Nome</h3>
                <div class="flex space-x-2">
                    <input type="search" id="search-input" placeholder="Ex: Gilman Glacier" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ÁREA PRINCIPAL: Mapa -->
        <main class="flex-1 relative">
            <div id="map" class="h-full w-full"></div>
            
            <div id="info-panel" class="absolute top-0 right-0 h-full w-full md:w-1/2 lg:w-1/3 bg-gray-900 bg-opacity-50 backdrop-blur-xl border-l border-gray-700 shadow-2xl p-6 z-[1001] transform translate-x-full pointer-events-auto overflow-y-auto">
                <button id="close-panel" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
                <div id="info-content">
                    <h2 id="glacier-name" class="text-3xl font-bold text-cyan-400 mb-2">Detalhes da Geleira</h2>
                    <p id="glacier-country" class="text-xl text-gray-300 mb-6 border-b border-gray-700 pb-4"></p>
                    <div class="bg-gray-800 p-4 rounded-lg">
                         <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 19
    }).addTo(map);

    let historyChartInstance;
    let historicoGeleirasData = {};
    let currentGlacierLayer = null;
    const loadingIndicator = document.getElementById('loading-indicator');
    const paisSelect = document.getElementById('pais-select');
    const continenteSelect = document.getElementById('continente-select');

    function getColor(taxaRecuoAnual) {
        if (typeof taxaRecuoAnual !== 'number' || isNaN(taxaRecuoAnual)) return '#808080';
        return taxaRecuoAnual < -100 ? '#b30000' :
               taxaRecuoAnual < -50  ? '#e34a33' :
               taxaRecuoAnual < -10  ? '#fc8d59' :
               taxaRecuoAnual < -1   ? '#fdbb84' : '#fee8c8';
    }

    function styleFeature(feature) {
        const props = feature.properties;
        const style = { weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7, fillColor: getColor(props.taxa_recuo_anual_km2) };
        if (feature.geometry.type === "Point") style.radius = 8;
        return style;
    }
    
    function onGlacierClick(e) {
        const props = e.target.feature.properties;
        document.getElementById('glacier-name').textContent = props.glac_name || 'Geleira sem nome';
        document.getElementById('glacier-country').textContent = props.pais || 'País não identificado';
        document.getElementById('info-panel').style.transform = 'translateX(0)';
        const historyData = historicoGeleirasData[props.glac_id] || [];
        const labels = historyData.map(d => new Date(d.data_observacao).getFullYear());
        const data = historyData.map(d => d.area_km2_calculada);
        const ctx = document.getElementById('historyChart').getContext('2d');
        if (historyChartInstance) historyChartInstance.destroy();
        historyChartInstance = new Chart(ctx, {
            type: 'line', data: { labels, datasets: [{ label: 'Área (km²)', data, borderColor: '#67e8f9', backgroundColor: 'rgba(103, 232, 249, 0.2)', fill: true, tension: 0.1 }] },
            options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Histórico de Área', color: 'white' } }, scales: { x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } } } }
        });
    }

    function onEachFeature(feature, layer) {
        layer.on({ click: onGlacierClick });
        const props = feature.properties;
        const popupContent = `<b>${props.glac_name || 'Geleira'}</b><br>País: ${props.pais}<br>Taxa de Recuo: <b>${(props.taxa_recuo_anual_km2 || 0).toFixed(2)} km²/ano</b>`;
        layer.bindTooltip(popupContent);
    }

    async function fetchAndDrawGlaciers(apiUrl) {
        try {
            if (currentGlacierLayer) map.removeLayer(currentGlacierLayer);
            loadingIndicator.classList.remove('hidden');
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Falha ao carregar dados: ${(await response.json()).detail}`);
            const geojsonData = await response.json();
            if (geojsonData && geojsonData.features && geojsonData.features.length > 0) {
                currentGlacierLayer = L.geoJSON(geojsonData, {
                    pointToLayer: (feature, latlng) => L.circleMarker(latlng),
                    style: styleFeature,
                    onEachFeature: onEachFeature
                }).addTo(map);
                 map.fitBounds(currentGlacierLayer.getBounds().pad(0.1));
            } else {
                alert('Nenhuma geleira encontrada para os filtros selecionados.');
            }
        } catch (error) {
            console.error('ERRO AO CARREGAR DADOS:', error);
            alert('Não foi possível carregar os dados. Verifique o Console (F12) e se o servidor está em execução.');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    async function initialLoad() {
        const [historicoResponse, statsResponse, paisesResponse] = await Promise.all([
            fetch('http://127.0.0.1:8000/api/historico_completo'),
            fetch('http://127.0.0.1:8000/api/estatisticas_globais'),
            fetch('http://127.0.0.1:8000/api/lista_paises')
        ]);

        if (historicoResponse.ok) historicoGeleirasData = await historicoResponse.json();
        
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            const dashboard = document.getElementById('stats-dashboard');
            dashboard.innerHTML = `
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p id="total-geleiras" class="text-gray-400 text-sm">Geleiras Analisadas</p><p class="text-2xl font-bold text-white">${(stats.total_geleiras_analisadas || 0).toLocaleString('pt-BR')}</p></div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p id="perda-total" class="text-gray-400 text-sm">Perda Total</p><p class="text-2xl font-bold text-red-400">${Math.round(stats.perda_total_global_km2 || 0).toLocaleString('pt-BR')} km²</p></div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700"><p id="media-recuo" class="text-gray-400 text-sm">Média de Recuo Anual</p><p class="text-2xl font-bold text-yellow-400">${(stats.media_global_recuo_anual_km2 || 0).toFixed(2)} km²/ano</p></div>
            `;
        }
        
        // Limpa o "A carregar..." e preenche a lista de países
        paisSelect.innerHTML = '<option>Todos</option>';
        if (paisesResponse.ok) {
            const paises = await paisesResponse.json();
            paises.forEach(pais => {
                const option = document.createElement('option');
                option.value = pais;
                option.textContent = pais;
                paisSelect.appendChild(option);
            });
        } else {
            const errorOption = document.createElement('option');
            errorOption.textContent = 'Erro ao carregar';
            errorOption.disabled = true;
            paisSelect.appendChild(errorOption);
        }
        
        document.getElementById('filter-button').click();
    }

    document.getElementById('filter-button').addEventListener('click', () => {
        const anoInicial = document.getElementById('ano-inicial').value;
        const anoFinal = document.getElementById('ano-final').value;
        const continente = continenteSelect.value;
        const pais = paisSelect.value;
        if (anoInicial && anoFinal) {
            fetchAndDrawGlaciers(`http://127.0.0.1:8000/api/geleiras_filtradas?ano_inicial=${anoInicial}&ano_final=${anoFinal}&continente=${continente}&pais=${pais}`);
        }
    });

    document.getElementById('search-button').addEventListener('click', () => {
        const searchTerm = document.getElementById('search-input').value;
        if(searchTerm) fetchAndDrawGlaciers(`http://127.0.0.1:8000/api/buscar_geleira?nome=${searchTerm}`);
    });
    
    continenteSelect.addEventListener('change', () => {
        if (continenteSelect.value !== 'Todos') paisSelect.value = 'Todos';
    });
    paisSelect.addEventListener('change', () => {
        if (paisSelect.value !== 'Todos') continenteSelect.value = 'Todos';
    });

    document.getElementById('close-panel').addEventListener('click', () => {
        document.getElementById('info-panel').style.transform = 'translateX(100%)';
    });

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        const grades = [-100, -50, -10, -1, 0];
        const labels = ['<strong>Taxa de Recuo (km²/ano)</strong>'];
        for (let i = 0; i < grades.length; i++) {
            labels.push(`<i style="background:${getColor(grades[i])}"></i> ${grades[i]}` + (grades[i+1] ? ` &ndash; ${grades[i+1]}` : '+'));
        }
        div.innerHTML = labels.join('<br>');
        return div;
    };
    legend.addTo(map);

    initialLoad();
});
</script>

</body>
</html>
